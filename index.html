<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת לבדיקת מבחני תקשורת - מבוסס הכל בכף</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22; /* כתום - מזכיר את צבעי הכל בכף */
            --light-bg: #f8f9fa;
            --sidebar-w: 20%;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: var(--light-bg); }
        
        /* סרגל צד - 20% */
        aside {
            width: var(--sidebar-w);
            background: white;
            border-left: 1px solid #ddd;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
        }

        /* מסך ראשי - 70% (השארנו שוליים) */
        main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            max-width: 80%;
            margin: 0 auto;
        }

        h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: var(--primary); }
        
        .input-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        button.primary-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            width: 100%;
        }
        button.primary-btn:hover { background-color: #34495e; }
        button.primary-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* כרטיסי שאלות */
        .question-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-right: 5px solid var(--accent);
        }

        .q-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; color: #333; }

        /* סעיפי פירוק */
        .breakdown-item {
            background: #fff8e1;
            border: 1px solid #ffe0b2;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .tag {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 8px;
        }

        textarea {
            width: 100%;
            min-height: 60px;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }

        .approve-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 5px;
        }
        .approve-btn.approved { background: #95a5a6; cursor: default; }

        /* אזור תשובת תלמיד */
        .student-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
            opacity: 0.5;
            pointer-events: none;
        }
        .student-area.active { opacity: 1; pointer-events: all; }

        .grade-box {
            background: #e8f8f5;
            border: 1px solid #a2d9ce;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            color: #16a085;
            display: none;
        }
        
        .loading { text-align: center; color: var(--primary); display: none; }
    </style>
</head>
<body>

<aside>
    <h2><i class="fas fa-cogs"></i> הגדרות</h2>
    
    <div class="input-group">
        <label>Google Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="הדבק כאן את המפתח...">
    </div>

    <div class="input-group">
        <label>טעינת מבחן (DOCX/HTML):</label>
        <input type="file" id="fileInput" accept=".docx, .html">
    </div>

    <div style="flex:1"></div>
    
    <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
        * הניתוח מתבסס על מושגי "הכל בכף" ודרישות הבגרות.
    </div>

    <button id="analyzeBtn" class="primary-btn" disabled>
        התחל בניתוח <i class="fas fa-play"></i>
    </button>
</aside>

<main id="mainArea">
    <div id="placeholder" style="text-align:center; color:#999; margin-top:100px;">
        <i class="fas fa-file-invoice fa-4x"></i>
        <h3>אנא טען קובץ והזן מפתח API כדי להתחיל</h3>
    </div>
    
    <div id="loader" class="loading">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p>מנתח את המבחן ע"פ מושגי משרד החינוך...</p>
    </div>

    <div id="resultsContainer"></div>
</main>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    const fileInput = document.getElementById('fileInput');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const apiKeyInput = document.getElementById('apiKey');
    const resultsContainer = document.getElementById('resultsContainer');
    const loader = document.getElementById('loader');
    const placeholder = document.getElementById('placeholder');

    let rawText = "";
    let questionData = []; // To store the state

    // 1. טעינת קובץ
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        if (file.name.endsWith('.docx')) {
            const arrayBuffer = await file.arrayBuffer();
            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
            rawText = result.value;
        } else {
            rawText = await file.text();
        }
        
        checkReady();
    });

    apiKeyInput.addEventListener('input', checkReady);

    function checkReady() {
        if (rawText && apiKeyInput.value.length > 10) {
            analyzeBtn.disabled = false;
        }
    }

    // 2. הפעלת הניתוח הראשוני (פירוק שאלות)
    analyzeBtn.addEventListener('click', async () => {
        placeholder.style.display = 'none';
        loader.style.display = 'block';
        resultsContainer.innerHTML = '';

        const genAI = new GoogleGenerativeAI(apiKeyInput.value);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        // הפרומפט שמשלב את "הכל בכף"
        const prompt = `
        אתה מורה מומחה לתקשורת וחברה המכין תלמידים לבגרות בישראל.
        המשימה: נתח את הטקסט הבא (מבחן תלמיד) ופרק אותו בצורה דידקטית.
        
        עקרונות מנחים לניתוח (מתוך אתר "הכל בכף"):
        1. התייחס להגדרות המדויקות של מושגים (למשל: ההבדל בין מיתוס לאתוס, סוכני חיברות, דגמי תקשורת).
        2. זהה מילות מטלה: "הצג" (הגדרה תיאורטית), "הסבר" (קישור), "הדגם" (יישום), "נמק".
        
        עבור כל שאלה בטקסט:
        1. זהה את השאלה.
        2. זהה את תשובת התלמיד (אם קיימת בטקסט).
        3. פרק את השאלה לתתי-סעיפים לפי מילות המטלה.
        4. לכל תת-סעיף, כתוב "מחוון מוצע" המבוסס על הידע המקצועי של תוכנית הלימודים.

        החזר את התשובה אך ורק בפורמט JSON חוקי במבנה הבא:
        [
          {
            "id": 1,
            "question": "text of question",
            "student_answer": "text of answer found",
            "parts": [
              {
                "verb": "הצג/הסבר...",
                "instruction": "what to do",
                "rubric": "detailed academic definition from Israeli syllabus"
              }
            ]
          }
        ]
        
        הטקסט לניתוח:
        ${rawText}
        `;

        try {
            const result = await model.generateContent(prompt);
            const response = result.response.text();
            
            // ניקוי ה-JSON (לפעמים מגיע עם Markdown)
            const jsonStr = response.replace(/```json/g, '').replace(/```/g, '').trim();
            questionData = JSON.parse(jsonStr);
            
            renderQuestions();
        } catch (error) {
            console.error(error);
            alert('אירעה שגיאה בניתוח. בדוק את מפתח ה-API או את הקובץ.');
        } finally {
            loader.style.display = 'none';
        }
    });

    // 3. הצגת השאלות למסך
    function renderQuestions() {
        resultsContainer.innerHTML = '';
        
        questionData.forEach((q, index) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            // כותרת שאלה
            let html = `<div class="q-text">שאלה ${index + 1}: ${q.question}</div>`;
            
            // חלקים (מחוון)
            html += `<div id="rubric-container-${index}">`;
            q.parts.forEach((part, pIndex) => {
                html += `
                <div class="breakdown-item">
                    <div>
                        <span class="tag">${part.verb}</span> 
                        <strong>${part.instruction}</strong>
                    </div>
                    <textarea id="rubric-${index}-${pIndex}">${part.rubric}</textarea>
                    <button class="approve-btn" onclick="window.approveRubric(${index}, ${pIndex}, this)">
                        <i class="fas fa-check"></i> אשר סעיף זה
                    </button>
                </div>`;
            });
            html += `</div>`;

            // אזור תשובת תלמיד (חסום בהתחלה)
            html += `
            <div id="student-area-${index}" class="student-area">
                <h4><i class="fas fa-user-graduate"></i> תשובת התלמיד והערכה</h4>
                <p style="font-size:0.9rem; color:#777;">ניתן לערוך/לתקן את תשובת התלמיד לפני הבדיקה:</p>
                <textarea id="student-ans-${index}">${q.student_answer || ''}</textarea>
                
                <button class="primary-btn" style="margin-top:10px; width:auto;" onclick="window.gradeQuestion(${index})">
                    <i class="fas fa-calculator"></i> חשב ציון והערכה
                </button>

                <div id="grade-result-${index}" class="grade-box"></div>
            </div>`;

            card.innerHTML = html;
            resultsContainer.appendChild(card);
        });
    }

    // 4. לוגיקה: אישור מחוון
    window.approveRubric = (qIndex, pIndex, btn) => {
        const textarea = document.getElementById(`rubric-${qIndex}-${pIndex}`);
        textarea.disabled = true;
        textarea.style.backgroundColor = "#e8f8f5";
        btn.textContent = "אושר";
        btn.classList.add("approved");
        
        // בדיקה אם כל החלקים בשאלה אושרו
        const totalParts = questionData[qIndex].parts.length;
        const approvedParts = document.querySelectorAll(`#rubric-container-${qIndex} .approved`).length;
        
        if (approvedParts === totalParts) {
            document.getElementById(`student-area-${qIndex}`).classList.add('active');
        }
    };

    // 5. לוגיקה: חישוב ציון (קריאה שנייה ל-AI)
    window.gradeQuestion = async (qIndex) => {
        const studentAns = document.getElementById(`student-ans-${qIndex}`).value;
        const resultBox = document.getElementById(`grade-result-${qIndex}`);
        
        // איסוף המחוון המאושר
        let approvedRubric = "";
        questionData[qIndex].parts.forEach((part, i) => {
            const text = document.getElementById(`rubric-${qIndex}-${i}`).value;
            approvedRubric += `- סעיף ${i+1} (${part.verb}): ${text}\n`;
        });

        resultBox.style.display = 'block';
        resultBox.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מחשב ציון...';

        const genAI = new GoogleGenerativeAI(apiKeyInput.value);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        const prompt = `
        פעל כבודק בחינות בגרות קפדני בתקשורת וחברה.
        
        המחוון המאושר (הקריטריונים המדויקים):
        ${approvedRubric}
        
        תשובת התלמיד (לאחר עריכת המורה):
        ${studentAns}
        
        משימה:
        1. השווה את התשובה למחוון סעיף אחר סעיף.
        2. בדוק שימוש במינוח מקצועי נכון ("הכל בכף").
        3. תן ציון מספרי (0-100).
        4. כתוב משוב מילולי: מה היה טוב ומה חסר.
        
        החזר תשובה קצרה ב-HTML עם <b> להדגשות.
        `;

        try {
            const result = await model.generateContent(prompt);
            resultBox.innerHTML = result.response.text();
        } catch (error) {
            resultBox.textContent = "שגיאה בחישוב הציון";
        }
    };
</script>

</body>
</html>
